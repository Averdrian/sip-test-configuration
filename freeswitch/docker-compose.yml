services:
  client1:
    build:
      context: .
      dockerfile: UA.Dockerfile
    environment:
      PORT: "5091"
      CLIENT: "client1"
    container_name: client1
    tty: true
    networks:
      system-test:
        ipv4_address: 10.22.80.5
    ports:
      - "5091:5091"
    cap_add:
    - NET_ADMIN

  client2:
    build:
      context: .
      dockerfile: UA.Dockerfile
    environment:
      PORT: "5060"
      CLIENT: "client2"
    container_name: client2
    tty: true
    networks:
      system-test:
        ipv4_address: 10.22.80.6
    ports:
      - "5060:5060"
    cap_add:
    - NET_ADMIN

  freeswitch:
    # image: ghcr.io/zaleos/inivr-dev-system-db:1
    build:
      context: .
      dockerfile: FreeSwitch.Dockerfile
      args:
        - USER_ID=1000
        - GROUP_ID=1000
      # labels:
        # - or.opencontainers.image.source=https://github.com/Averdrian/sip-test-configuration
    volumes:
      - /home/zaleos/Workspaces/sip-test-configuration/freeswitch/coredumps:/var/crash
      -  ./scripts:/etc/freeswitch/scripts
      -  ./config:/etc/freeswitch
    ulimits:
      core: -1
    environment:
      - IP_INIVR=10.22.80.2
      - IP_FREESWITCH=10.22.80.3
    networks:
      system-test:
        ipv4_address: 10.22.80.3

  db:
    build:
      context: .
      dockerfile: Database.Dockerfile
    environment:
      - MYSQL_ROOT_PASSWORD=password
    healthcheck:
      test: ["CMD", "mysql", "-h", "10.5.0.3", "-u", "root", "-pmysecretpassword", "-e", "SELECT 1"]
      interval: 1s
      timeout: 1s
      retries: 60
      start_period: 30s
    volumes:
      - ./create_free.sql:/create_free.sql
    ulimits:
      core: -1
    networks:
      system-test:
        ipv4_address: 10.22.80.4

  web_service:
    build:
      context: .
      dockerfile: Flask.Dockerfile
    tty: true
    volumes:
    -  ./web_service:/app
    ports:
    -  "7000:7000"
    networks:
      system-test:
        ipv4_address: 10.22.80.7

networks:
  system-test:
    driver: bridge
    ipam:
      config:
        - subnet: 10.22.80.0/24
          gateway: 10.22.80.1
